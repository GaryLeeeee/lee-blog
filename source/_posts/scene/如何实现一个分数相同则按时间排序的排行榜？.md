---
title: 如何实现一个分数相同则按时间排序的排行榜？
date: 2023-08-20 16:13:57
tags: [Redis]
categories: [场景题]
---

## 一、如何实现一个排行榜？
可以使用Redis的zset集合来实现一个排行榜，原因是zset集合可以将分数作为score、用户ID作为value，同时结合zset的排序功能，实现分数从高到低排序，相关的操作命令如下：

**增加分数**：`zincrby <key> <score> <uid>`
**查询TopN**：`zrevrange <key> 0 <N-1> withscores`
**查询排行榜人数**：`zcard <key>`
**查询指定用户排名**：`zrank <key> <uid>` + 1
**查询指定用户分数**：`zscore <key> <uid>`
...

查询TopN时，按照的是分数排序，如果分数相同，默认是使用value值做字典排序（如a>b，1>2），而不是按照时间排序。那么，<font color=red>**如果想实现分数相同则按照时间排序应该怎么做呢？**</font>

## 二、如何实现分数相同则按照时间排序？
**分析**：由于查询TopN时是score越大排名越前，而我们想实现分数相同则按照时间排序，就需要结合时间戳来实现，而预期是插入时间越小排名越前（即分数相同时优先显示先插入的），跟score的规则是相反的
**解决方案**：将分数当做score的整数部分，时间戳当做score的小数部分，查询结果里只取整数部分的分数即可，具体计算为
```
-- 初始
score = 分数 + "." + 时间戳

-- 改为数学运算
score = 分数 + 时间戳 / 1^13

-- 倒序处理，使时间戳越小，score越大
score = 分数 + (1 - 时间戳 / 1^13)
```

## 三、Q&A
### 1、什么场景下要用到多个zset？
当需要设计一个多维度统计的排行榜时，就可能需要用到多个zset，比如我们有个每日签到打卡次数排行榜，除了总榜，还需要有日榜，所以设计如下：
* **查询用户日榜分数**：`zscore rank_20230901 <uid>`
* **查询用户总榜分数**：`zscore rank <uid>`
* **查询用户近三日榜分数（交集）**：`zunion rank_3_days 3 rank_20230901 rank_20230902 rank_20230903 weights 1 1 1`
* ...

### 2、除了Redis，还有什么实现排行榜的方案吗？
除了Redis，还可以使用MySQL的order by语句进行排序，不过要注意性能问题，确保排序字段加上索引。Redis比较适用于数据量大、更新频繁、访问频繁的场景，MySQL比较适用于数据量小、使用不频繁的场景。